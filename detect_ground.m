prefix='/Users/dhackett/Documents/Summer2021/RangeGateTests/';
RDRLIST=["LOLARDR_193230912.DAT"...
"LOLARDR_193580434.DAT"...
"LOLARDR_200100314.DAT"...
"LOLARDR_200240328.DAT"...
"LOLARDR_201480405.DAT"...
"LOLARDR_210340337.DAT"...
"LOLARDR_210340534.DAT"...
"LOLARDR_210340731.DAT"...
"LOLARDR_210340928.DAT"...
"LOLARDR_210341126.DAT"...
"LOLARDR_210341323.DAT"...
"LOLARDR_210341520.DAT"...
"LOLARDR_210341717.DAT"...
"LOLARDR_210341914.DAT"...
"LOLARDR_210342111.DAT"...
"LOLARDR_210342309.DAT"...
"LOLARDR_210350106.DAT"...
"LOLARDR_210350303.DAT"...
"LOLARDR_210351052.DAT"...
"LOLARDR_210351249.DAT"...
"LOLARDR_210351446.DAT"...
"LOLARDR_210351643.DAT"...
"LOLARDR_210361610.DAT"...
"LOLARDR_210361807.DAT"...
"LOLARDR_210362004.DAT"...
"LOLARDR_210362201.DAT"...
"LOLARDR_210362358.DAT"...
"LOLARDR_210370155.DAT"...
"LOLARDR_210911413.DAT"...
"LOLARDR_210920156.DAT"...
"LOLARDR_211000858.DAT"...
"LOLARDR_211181744.DAT"...
"LOLARDR_211200450.DAT"...
"LOLARDR_211200647.DAT"...
"LOLARDR_211200844.DAT"...
"LOLARDR_211201041.DAT"...
"LOLARDR_211201238.DAT"...
"LOLARDR_211201435.DAT"...
"LOLARDR_211201632.DAT"...
"LOLARDR_211201829.DAT"...
"LOLARDR_211202026.DAT"...
"LOLARDR_211202223.DAT"...
"LOLARDR_211210020.DAT"...
"LOLARDR_211210414.DAT"...
"LOLARDR_211210808.DAT"...
"LOLARDR_211211202.DAT"...
"LOLARDR_211211556.DAT"...
"LOLARDR_211212344.DAT"...
"LOLARDR_211220338.DAT"...
"LOLARDR_211220732.DAT"...
"LOLARDR_211221126.DAT"...
"LOLARDR_211221520.DAT"...
"LOLARDR_211222308.DAT"...
"LOLARDR_211230302.DAT"...
"LOLARDR_211230657.DAT"...
"LOLARDR_211231051.DAT"...
"LOLARDR_211231445.DAT"...
"LOLARDR_211251140.DAT"...
"LOLARDR_211251337.DAT"...
"LOLARDR_211251534.DAT"...
"LOLARDR_211251731.DAT"...
"LOLARDR_211251929.DAT"...
"LOLARDR_211261106.DAT"...
"LOLARDR_211261303.DAT"...
"LOLARDR_211261501.DAT"...
"LOLARDR_211261658.DAT"...
"LOLARDR_211261855.DAT"...
"LOLARDR_211410440.DAT"...
"LOLARDR_211410638.DAT"...
"LOLARDR_211411032.DAT"...
"LOLARDR_211411427.DAT"...
"LOLARDR_211411624.DAT"...
"LOLARDR_211411821.DAT"...
"LOLARDR_211412018.DAT"...
"LOLARDR_211412216.DAT"...
"LOLARDR_211420013.DAT"...
"LOLARDR_211432306.DAT"...
"LOLARDR_211440852.DAT"...
"LOLARDR_211441049.DAT"...
"LOLARDR_211441443.DAT"...
"LOLARDR_211441838.DAT"...
"LOLARDR_211442035.DAT"...
"LOLARDR_211442232.DAT"...
"LOLARDR_211450818.DAT"...
"LOLARDR_211451015.DAT"...
"LOLARDR_211451213.DAT"...
"LOLARDR_211451410.DAT"...
"LOLARDR_211451804.DAT"...
"LOLARDR_211452001.DAT"...
"LOLARDR_211452159.DAT"...
"LOLARDR_211452356.DAT"...
"LOLARDR_211460153.DAT"...
"LOLARDR_211480441.DAT"...
"LOLARDR_211480638.DAT"...
"LOLARDR_211480835.DAT"...
"LOLARDR_211481033.DAT"...
"LOLARDR_211481822.DAT"...
"LOLARDR_211482019.DAT"...
"LOLARDR_211482216.DAT"...
"LOLARDR_211490802.DAT"...
"LOLARDR_211491000.DAT"...
"LOLARDR_211491157.DAT"...
"LOLARDR_211491354.DAT"...
"LOLARDR_211491748.DAT"...
"LOLARDR_211491946.DAT"...
"LOLARDR_211492143.DAT"...
"LOLARDR_211492340.DAT"...
"LOLARDR_211500532.DAT"...
"LOLARDR_211500926.DAT"...
"LOLARDR_211501124.DAT"...
"LOLARDR_211501321.DAT"...
"LOLARDR_211501715.DAT"...
"LOLARDR_211502110.DAT"...
"LOLARDR_211510459.DAT"...
"LOLARDR_211511051.DAT"...
"LOLARDR_211511248.DAT"...
"LOLARDR_211511445.DAT"...
"LOLARDR_211511642.DAT"...
"LOLARDR_211511840.DAT"...
"LOLARDR_211512037.DAT"...
"LOLARDR_211520623.DAT"...
"LOLARDR_211520820.DAT"...
"LOLARDR_211521017.DAT"...
"LOLARDR_211521609.DAT"...
"LOLARDR_211521806.DAT"...
"LOLARDR_211522004.DAT"...
"LOLARDR_211522201.DAT"...
"LOLARDR_211530352.DAT"...
"LOLARDR_211530550.DAT"...
"LOLARDR_211530944.DAT"...
"LOLARDR_211531339.DAT"...
"LOLARDR_211531536.DAT"...
"LOLARDR_211531733.DAT"...
"LOLARDR_211531930.DAT"...
"LOLARDR_211540911.DAT"...
"LOLARDR_211541108.DAT"...
"LOLARDR_211541305.DAT"...
"LOLARDR_211541503.DAT"...
"LOLARDR_211541700.DAT"...
"LOLARDR_211541857.DAT"...
"LOLARDR_211542054.DAT"...
"LOLARDR_211550246.DAT"...
"LOLARDR_211550443.DAT"...
"LOLARDR_211551035.DAT"...
"LOLARDR_211551232.DAT"...
"LOLARDR_211551429.DAT"...
"LOLARDR_211552021.DAT"...
"LOLARDR_211552218.DAT"...
"LOLARDR_211680917.DAT"...
"LOLARDR_211681311.DAT"...
"LOLARDR_211681509.DAT"...
"LOLARDR_211681706.DAT"...
"LOLARDR_211681903.DAT"...
"LOLARDR_211682100.DAT"...
"LOLARDR_211690055.DAT"...
"LOLARDR_211690647.DAT"...
"LOLARDR_211690844.DAT"...
"LOLARDR_211691041.DAT"...
"LOLARDR_211691238.DAT"...
"LOLARDR_211691436.DAT"...
"LOLARDR_211692027.DAT"...
"LOLARDR_211692224.DAT"...
"LOLARDR_211700416.DAT"...
"LOLARDR_211700613.DAT"...
"LOLARDR_211700811.DAT"...
"LOLARDR_211701008.DAT"...
"LOLARDR_211701205.DAT"...
"LOLARDR_211701954.DAT"...
"LOLARDR_211702151.DAT"...
"LOLARDR_211710343.DAT"...
"LOLARDR_211710540.DAT"...
"LOLARDR_211710738.DAT"...
"LOLARDR_211711329.DAT"...
"LOLARDR_211711527.DAT"...
"LOLARDR_211711724.DAT"...
"LOLARDR_211711921.DAT"...
"LOLARDR_211720113.DAT"...
"LOLARDR_211720902.DAT"...
"LOLARDR_211721256.DAT"...
"LOLARDR_211721651.DAT"...
"LOLARDR_211721848.DAT"...
"LOLARDR_211722045.DAT"...
"LOLARDR_211722242.DAT"...
"LOLARDR_211730434.DAT"...
"LOLARDR_211730631.DAT"...
"LOLARDR_211730828.DAT"...
"LOLARDR_211731026.DAT"...
"LOLARDR_211731223.DAT"...
"LOLARDR_211731815.DAT"...
"LOLARDR_211732209.DAT"...
"LOLARDR_211740558.DAT"...
"LOLARDR_211740755.DAT"...
"LOLARDR_211741150.DAT"...
"LOLARDR_211741347.DAT"...
"LOLARDR_211741544.DAT"...
"LOLARDR_211741939.DAT"...
"LOLARDR_211742136.DAT"...
"LOLARDR_211750328.DAT"...
"LOLARDR_211750525.DAT"...
"LOLARDR_211750920.DAT"...
"LOLARDR_211751117.DAT"...
"LOLARDR_211751709.DAT"...
"LOLARDR_211751906.DAT"...
"LOLARDR_211752103.DAT"...
"LOLARDR_211760453.DAT"...
"LOLARDR_211760847.DAT"...
"LOLARDR_211761242.DAT"...
"LOLARDR_211761439.DAT"...
"LOLARDR_211761636.DAT"...
"LOLARDR_211761833.DAT"...
"LOLARDR_211762031.DAT"...
"LOLARDR_211770420.DAT"...
"LOLARDR_211771209.DAT"...
"LOLARDR_211771406.DAT"...
"LOLARDR_211771603.DAT"...
"LOLARDR_211771801.DAT"...
"LOLARDR_211771958.DAT"...
"LOLARDR_211772155.DAT"...
"LOLARDR_211800636.DAT"...
"LOLARDR_211801228.DAT"...
"LOLARDR_211801425.DAT"...
"LOLARDR_211801622.DAT"...
"LOLARDR_211801819.DAT"...
"LOLARDR_211802017.DAT"...
"LOLARDR_211802214.DAT"...
"LOLARDR_211810406.DAT"...
"LOLARDR_211810957.DAT"...
"LOLARDR_211811352.DAT"...
"LOLARDR_211811549.DAT"...
"LOLARDR_211811747.DAT"...
"LOLARDR_211811944.DAT"...
"LOLARDR_211812141.DAT"...
"LOLARDR_211820333.DAT"...
"LOLARDR_211820530.DAT"...
"LOLARDR_211820925.DAT"...
"LOLARDR_211821319.DAT"...
"LOLARDR_211821714.DAT"...
"LOLARDR_211821911.DAT"...
"LOLARDR_211822109.DAT"...
"LOLARDR_211970314.DAT"...
"LOLARDR_211970511.DAT"...
"LOLARDR_211970905.DAT"...
"LOLARDR_211971103.DAT"...
"LOLARDR_211971457.DAT"...
"LOLARDR_211971655.DAT"...
"LOLARDR_211971852.DAT"...
"LOLARDR_211980044.DAT"...
"LOLARDR_211980241.DAT"...
"LOLARDR_211980635.DAT"...
"LOLARDR_211981030.DAT"...
"LOLARDR_211981227.DAT"...
"LOLARDR_211981819.DAT"...
"LOLARDR_211982214.DAT"...
"LOLARDR_211990011.DAT"...
"LOLARDR_211990208.DAT"...
"LOLARDR_211990405.DAT"...
"LOLARDR_211991352.DAT"...
"LOLARDR_211991549.DAT"...
"LOLARDR_211991943.DAT"...
"LOLARDR_211992338.DAT"...
];
rgt_results=zeros(length(RDRLIST),19);  % results array

% rgt_results column order: [solar incidence] [range] [SNR 1] [SNR 2] [SNR
% 3] [SNR 4] [SNR 5] [THR 1] [THR 2] [THR 3] [THR 4] [THR 5] [GRR 1] [GRR
% 2] [GRR 3] [GRR 4] [GRR 5] [lat] [lon]
% (GRR = ground return rate)

incidence_filter=true;  % exclude RGTs w/ average solinc>70?
range_filter=true;      % exclude RGTs w/ average range>75?

for i=1:length(RDRLIST)
  curr=num2str(i);
  sz=num2str(length(RDRLIST));
  strcat(curr, '/', sz, ' RDRs processed')
  [avgthrs, avgrnge, avglat, avglon, rad, et, avginc, snr, goodrt] = detect_groundF(strcat(prefix, RDRLIST(i)));
  rgt_results(i, 1)=avginc; % solar incidence
  rgt_results(i, 2)=avgrnge;    % range
  rgt_results(i, 18)=avglat;    % latitude
  rgt_results(i, 19)=avglon;    % longitude
  for j=1:5
      rgt_results(i, j+2)=snr(j);   % signal to noise contrast, detectors 1-5
      rgt_results(i, j+7)=avgthrs(j);   % thresholds, detectors 1-5
      rgt_results(i,j+12)=goodrt(j);    % average ground return detection rate, detectors 1-5

  end
end

% disregards any range gate test with average solinc > 70, if flag = true
if incidence_filter
    for i=1:length(rgt_results)
        if rgt_results(i,1)>70
            rgt_results(i,:)=NaN;
        end
    end
end

% disregards any range gate test with average range >75, if flag = true
if range_filter
    for i=1:length(rgt_results)
        if rgt_results(i,2)>75
            rgt_results(i,:)=NaN;
        end
    end
end

rgt_results

% [thr, avgrnge, rad, et, avginc, snr] = detect_groundF('/Users/dhackett/Documents/Summer2021/RangeGateTests/LOLARDR_193230912.DAT');


function [avgthrs, avgrnge, avglat, avglon, rad, et, avginc, snr, goodrt] = detect_groundF(RDRin)

GRDfile='/Users/dhackett/Documents/Summer2021/LDEM_64.GRD';
[zt_,xt,yt]=readGRD(GRDfile);

%%

ispots=1:5;

[lon,lat,rad,et,met,flg,scrad,time,offndr,pw,en,rnge,rflct,...
  xenrg,sclon,sclat,noi,thr,gn,emi,inc,phs,...
  earth_range,earth_pulse,local_soltim,earth_energy] = readRDRfunc(RDRin,ispots);

%%

time0=find(xenrg(:,1)>.75); % find when RGT ocurring
stime=et(time0(1));
etime=et(time0(end));
dtime=etime-stime;
avgrnge=time0;
avginc=time0;
avglat=time0;
avglon=time0;

for i=1:length(time0)
    avgrnge(i)=rnge(time0(i),1);
    avginc(i)=inc(time0(i));
    avgthr1(i)=thr(time0(i), 1);
    avgthr2(i)=thr(time0(i), 2);
    avgthr3(i)=thr(time0(i), 3);
    avgthr4(i)=thr(time0(i), 4);
    avgthr5(i)=thr(time0(i), 5);
    avglat(i)=lat(time0(i));
    avglon(i)=lon(time0(i));
    
end

avgrnge=mean(avgrnge);
avginc=mean(avginc);
avgthr1=mean(avgthr1);
avgthr2=mean(avgthr2);
avgthr3=mean(avgthr3);
avgthr4=mean(avgthr4);
avgthr5=mean(avgthr5);
avglat=mean(avglat);
avglon=mean(avglon);
avgthrs=[avgthr1, avgthr2, avgthr3, avgthr4, avgthr5];

is=2;
k=find(and(abs(rad(:,is))<20,lat(:,is)>-90));

clf;
% plot(et(k),rad(k,is),'.');

zvec=-900:10:900;
nfl=[1:5];
ngood=[1:5];
snr=[1:5];
goodrt=[1:5];

clf; %hold on; box on; set(gca,'FontSize',15);
for is=1:5
    k=find(and(abs(rad(:,is))<20,lat(:,is)>-90));
    zi=interp2(xt,yt,zt_,lon(k,is),lat(k,is));
    dz=(rad(k,is)-zi)*1e3; dz(abs(dz)>1.2*max(abs(zvec)))=[];
    ni=hist(dz,zvec);
    nfl(is)=mean(ni(111:171));  %  "noise floor," calculated from right tail of histogram
    ntotal(is)=sum(ni(88:94)); % +/- 30m ground return window
    ngood(is)=ntotal(is)-(nfl(is)*7);
    snr(is)=(ngood(is)/7)/nfl(is);  % signal to noise ratio or contrast 
    
    if ngood(is) < 10   % if # ground returns during track < 10, exclude snr results
        snr(is)=NaN;    
    end
    goodrt(is)=ngood(is)/dtime;     % ground return detection rate
%     plot(zvec,ni,'-','LineWidth',2);
end


% set(gca,'XLim',[min(zvec) max(zvec)]);
% legend(num2str((1:5)'));
% xlabel('Difference with LDEM\_64 (m) ');
% ylabel('Histogram counts (10-m bins)');
% title(RDRin);
end
%%